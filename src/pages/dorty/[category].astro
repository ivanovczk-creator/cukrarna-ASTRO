---
import Layout from '../../layouts/Layout.astro';
import productsData from '../../../data.json';
import ReservationForm from '../../components/ReservationForm.tsx';
import { Image } from 'astro:assets';

export async function getStaticPaths() {
  const categories = [
    { 
      id: 'detske', 
      title: 'Dětské dorty', 
      description: 'Nechte se unést do světa pohádek! Naše dětské narozeninové dorty tvoříme s ohledem na dětskou fantazii. Od oblíbených postaviček po veselá zvířátka – každý dort je ručně modelovaný originál, který rozzáří oči každého malého oslavence.' 
    },
    { 
      id: 'narozeninove', 
      title: 'Narozeninové dorty', 
      description: 'Hledáte dokonalý narozeninový dort pro děti i dospělé? Naše cukrářky pečou z poctivých surovin a zdobí dorty tak, aby byly ozdobou každé oslavy. Vyberte si z klasických příchutí nebo moderních kombinací.' 
    },
    { 
      id: 'svatebni', 
      title: 'Svatební dorty', 
      description: 'Váš velký den si zaslouží dokonalou sladkou tečku. Naše svatební dorty kombinují nadčasovou eleganci s prvotřídní chutí. Nabízíme klasické potahované dorty i moderní styly, které sladíme s barvou a stylem vaší svatby.' 
    },
    { 
      id: 'nahe', 
      title: 'Nahé dorty', 
      description: 'Hledáte přirozenost a svěžest? Nahé a polonahé dorty zdobíme bohatou vrstvou čerstvého sezónního ovoce a živými květy. Ideální volba pro zahradní oslavy a milovníky méně sladkých, lehkých dezertů.' 
    },
    { 
      id: 'krtiny', 
      title: 'Dorty ke křtinám', 
      description: 'Oslavte první velký milník vašeho miminka s jemností. Dorty ke křtinám připravujeme v decentních pastelových barvách s tradičními symboly andílků či botiček. Zakládáme si na lehkých krémech a jemném zdobení.' 
    },
    { 
      id: 'elegantni', 
      title: 'Elegantní dorty', 
      description: 'Pro významná životní jubilea a luxusní oslavy. Naše elegantní dorty sází na minimalistický design, precizní detaily, jedlé zlato nebo moderní techniky zdobení. Dokonalý dárek pro každého, kdo ocení styl a kvalitu.' 
    },
    { 
      id: '3d-netradicni', 
      title: '3D a netradiční dorty', 
      description: 'Pro nás neexistuje nemožné! Potřebujete dort ve tvaru auta, láhve nebo kytary? 3D modelované dorty jsou naší specialitou. Každý detail je ručně vypracován tak, aby výsledek bral dech.' 
    }
  ];

  return categories.map(cat => ({
    params: { category: cat.id },
    props: { info: cat }
  }));
}

const { category } = Astro.params;
const { info } = Astro.props;

const filteredCakes = productsData.cakes.filter(cake => 
  cake.category_list && cake.category_list.includes(category)
);

const cakeImages = import.meta.glob<{ default: ImageMetadata }>('/public/img/dorty/*.{jpeg,jpg,png,webp,JPG,JPEG}', { eager: true });

function getImage(path: string, images: Record<string, any>) {
	if (!path) return null;
	const normalizedPath = path.startsWith('/public') ? path : (path.startsWith('/') ? `/public${path}` : `/public/${path}`);
	return images[normalizedPath]?.default || null;
}
---

<Layout title={`${info.title} | Cukrářství Blahutovi`} description={info.description}>
	<header class="bg-[#0a192f] text-white sticky top-0 z-50 border-b-2 border-[#d4af37]">
		<div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
			<a href="/" class="text-xl md:text-2xl font-serif text-[#d4af37] no-underline">Cukrářství Blahutovi</a>
			<div class="flex items-center gap-4">
				<ReservationForm client:load />
				<a href="/" class="text-[#d4af37] uppercase text-[10px] font-bold tracking-widest border border-[#d4af37] px-4 py-2 rounded-xl hover:bg-[#d4af37] hover:text-[#0a192f] transition-all">Zpět</a>
			</div>
		</div>
	</header>

	<main class="py-16 px-4 bg-slate-50 min-h-screen font-bold">
		<div class="max-w-7xl mx-auto">
			<nav class="text-xs uppercase tracking-widest text-slate-400 mb-6 font-bold">
				<a href="/" class="hover:text-[#d4af37]">Domů</a> / <a href="/#dorty" class="hover:text-[#d4af37]">Dorty</a> / <span class="text-slate-600 font-bold">{info.title}</span>
			</nav>

			<div class="mb-12 border-l-4 border-[#d4af37] pl-6 py-2 max-w-4xl">
				<h1 class="text-4xl md:text-5xl font-serif mb-4 text-[#0a192f] italic font-bold">{info.title}</h1>
				<p class="text-slate-600 text-lg leading-relaxed font-bold">{info.description}</p>
			</div>

			{filteredCakes.length > 0 ? (
				<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
					{filteredCakes.map((cake) => {
						const imageSrc = getImage(cake.foto, cakeImages);
						return (
							<div class="group bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden flex flex-col hover:shadow-2xl transition-all duration-500 font-bold">
								<div class="h-72 overflow-hidden relative">
									{imageSrc ? (
										<a href={cake.foto} class="glightbox block h-full" aria-label={`Detail ${cake.title}`}>
											<Image 
                        src={imageSrc} 
                        alt={cake.title} 
                        class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" 
                        width={400} 
                        height={500} 
                        format="webp" 
                      />
                      <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors duration-500 font-bold"></div>
										</a>
									) : (
										<div class="flex items-center justify-center h-full bg-slate-100 text-slate-300 italic uppercase text-[10px] tracking-widest font-bold">Foto připravujeme</div>
									)}
								</div>
								<div class="p-8 flex-grow flex flex-col font-bold">
									<h3 class="text-xl font-bold text-[#0a192f] mb-2 leading-tight font-bold">{cake.title}</h3>
									<p class="text-slate-400 text-[10px] uppercase tracking-[0.2em] font-bold mb-6 font-bold">{cake.porce}</p>
									<div class="mt-auto flex justify-between items-center pt-6 border-t border-slate-50 font-bold">
										<span class="text-[#92782a] font-black text-2xl font-bold">{cake.cena}</span>
										<button 
											onclick={`window.dispatchEvent(new CustomEvent('add-to-cart', { detail: { name: "${cake.title}", price: "${cake.cena}", img: "${cake.foto}", quantity: 1 } }))`}
											class="bg-[#0a192f] text-white w-12 h-12 rounded-2xl hover:bg-[#d4af37] transition-all duration-300 flex items-center justify-center shadow-lg active:scale-90 font-bold"
                      title="Přidat do objednávky"
										>
											<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8
