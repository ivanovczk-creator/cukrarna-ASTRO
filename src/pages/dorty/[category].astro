---
import Layout from '../../layouts/Layout.astro';
import productsData from '../../../data.json';
import ReservationForm from '../../components/ReservationForm.tsx';
import { Image } from 'astro:assets';

// 1. Definujeme dostupné kategorie pro generování stránek
export async function getStaticPaths() {
  const categories = [
    { id: 'detske', title: 'Dětské dorty', description: 'Veselé a barevné dorty pro vaše nejmenší oslavence.' },
    { id: 'narozeninove', title: 'Narozeninové dorty', description: 'Originální narozeninové dorty pro děti i dospělé.' },
    { id: 'svatebni', title: 'Svatební dorty', description: 'Elegantní svatební dorty, které se stanou ozdobou vaší hostiny.' },
    { id: 'nahe', title: 'Nahé dorty', description: 'Moderní nahé dorty zdobené čerstvým ovocem a květy.' }
  ];

  return categories.map(cat => ({
    params: { category: cat.id },
    props: { info: cat }
  }));
}

const { category } = Astro.params;
const { info } = Astro.props;

// 2. Filtrujeme dorty, které mají danou kategorii v poli category_list
const filteredCakes = productsData.cakes.filter(cake => 
  cake.category_list && cake.category_list.includes(category)
);

const cakeImages = import.meta.glob<{ default: ImageMetadata }>('/public/img/dorty/*.{jpeg,jpg,png,webp,JPG,JPEG}', { eager: true });

function getImage(path: string, images: Record<string, any>) {
	if (!path) return null;
	const normalizedPath = path.startsWith('/public') ? path : (path.startsWith('/') ? `/public${path}` : `/public/${path}`);
	return images[normalizedPath]?.default || null;
}
---

<Layout title={`${info.title} | Cukrářství Blahutovi`} description={info.description}>
	<header class="bg-[#0a192f] text-white sticky top-0 z-50 border-b-2 border-[#d4af37]">
		<div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center relative">
			<a href="/" class="text-xl md:text-2xl font-serif text-[#d4af37] no-underline">Cukrářství Blahutovi</a>
			<div class="flex items-center gap-4">
				<ReservationForm client:load />
				<a href="/" class="text-[#d4af37] uppercase text-[10px] font-bold tracking-widest border border-[#d4af37] px-4 py-2 rounded-xl hover:bg-[#d4af37] hover:text-[#0a192f] transition-all">Zpět na hlavní web</a>
			</div>
		</div>
	</header>

	<main class="py-16 px-4">
		<div class="max-w-7xl mx-auto">
			<nav class="text-xs uppercase tracking-widest text-slate-400 mb-8 font-bold">
				<a href="/" class="hover:text-[#d4af37]">Domů</a> / <span class="text-[#0a192f]">Kategorie {info.title}</span>
			</nav>

			<h2 class="text-4xl md:text-5xl font-serif mb-4 italic text-[#0a192f]">{info.title}</h2>
			<p class="text-slate-600 mb-12 max-w-2xl text-lg leading-relaxed">{info.description}</p>

			{filteredCakes.length > 0 ? (
				<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8 text-center">
					{filteredCakes.map((cake) => {
						const imageSrc = getImage(cake.foto, cakeImages);
						return (
							<div class="bg-white rounded-[2rem] shadow-lg border border-slate-100 overflow-hidden flex flex-col transition-all hover:shadow-xl">
								<div class="h-64 overflow-hidden relative bg-slate-50">
									{imageSrc ? (
										<a href={cake.foto} class="glightbox cursor-zoom-in" aria-label={`Detail dortu ${cake.title}`}>
											<Image src={imageSrc} alt={cake.title} class="w-full h-full object-cover transition-transform duration-700 hover:scale-110" width={400} height={300} format="webp" />
										</a>
									) : (
										<div class="flex items-center justify-center h-full text-xs text-slate-300 italic">Foto připravujeme</div>
									)}
								</div>
								<div class="p-6 flex-grow flex flex-col justify-between">
									<h3 class="text-xl font-bold mb-1 text-[#0a192f]">{cake.title}</h3>
									<p class="text-slate-500 text-sm mb-4">{cake.porce}</p>
									<p class="text-[#92782a] font-black text-2xl mb-4">{cake.cena}</p>
									<button 
										aria-label={`Přidat ${cake.title} do objednávky`}
										onclick={`window.dispatchEvent(new CustomEvent('add-to-cart', { detail: { name: "${cake.title}", price: "${cake.cena}", img: "${cake.foto}", quantity: 1 } }))`}
										class="w-full bg-[#0a192f] text-white py-4 rounded-2xl font-bold hover:bg-[#d4af37] transition-all cursor-pointer uppercase tracking-widest text-[10px] active:scale-95 shadow-md"
									>
										Přidat do objednávky
									</button>
								</div>
							</div>
						);
					})}
				</div>
			) : (
				<div class="bg-slate-50 rounded-[2rem] p-12 text-center border-2 border-dashed border-slate-200">
					<p class="text-slate-400 italic">V této kategorii zatím nemáme žádné dorty, ale brzy je přidáme!</p>
				</div>
			)}
			
			{/* SEO TEXT - důležité pro vyhledávače */}
			<article class="mt-20 p-8 md:p-12 bg-white rounded-[3rem] border border-slate-100 shadow-sm text-slate-700 leading-relaxed">
				<h3 class="text-2xl font-serif text-[#0a192f] mb-4">Proč si vybrat naše {info.title.toLowerCase()}?</h3>
				<p class="mb-4">
					Naše {info.title.toLowerCase()} vyrábíme s láskou a důrazem na tradici od roku 1985. Používáme výhradně kvalitní suroviny – pravé máslo, čerstvou šlehačku a poctivou čokoládu. Každý kus je originál, vytvořený přesně podle vašich představ o designu i chuti.
				</p>
				<p>
					Dorty si můžete vyzvednout na kterékoliv z našich čtyř prodejen: Petřvald, Píšť, Karviná nebo Ostrava Zábřeh. Doporučujeme objednávku provést alespoň s dvoudenním předstihem, abychom vám mohli zaručit maximální čerstvost.
				</p>
			</article>
		</div>
	</main>

	<footer class="bg-[#0a192f] py-12 text-center text-white/40 text-xs border-t border-[#d4af37]/10">
		<p class="mb-2 italic text-[#d4af37] text-sm font-serif">Cukrářství Blahutovi</p>
		<p>© {new Date().getFullYear()} — Všechna práva vyhrazena</p>
	</footer>
</Layout>
