---
import Layout from '../layouts/Layout.astro';
import productsData from '../../data.json';

const cakes = (productsData?.cakes || []).sort((a, b) => (a.weight ?? 999) - (b.weight ?? 999));
const desserts = (productsData?.desserts || []).sort((a, b) => (a.weight ?? 999) - (b.weight ?? 999));

// Definice prodejen s pravidly pro blokování (0 = Neděle, 1 = Pondělí, ...)
const stores = [
	{ id: 'petrvald', name: 'Petřvald (Šenovská 1)', closed: [1], hours: 'Út-Ne: 9:00 - 17:00' },
	{ id: 'pist', name: 'Píšť (Hlavní 123)', closed: [0, 6], hours: 'Po-Pá: 7:00 - 18:00' },
	{ id: 'karvina', name: 'Karviná (Náměstí 456)', closed: [0], hours: 'Po-Pá: 9:00 - 18:00, So: 8-12' },
	{ id: 'ostrava', name: 'Ostrava (Hlavní třída 789)', closed: [0], hours: 'Po-So: 9:00 - 19:00' }
];
---

<Layout title="Cukrářství Blahutovi">
	<style is:global>
		:root { --navy: #0a192f; --gold: #d4af37; --white: #ffffff; }
		body { background-color: #fcfaf7; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding-bottom: 100px; }
		
		#cart-float {
			position: fixed; bottom: 30px; right: 30px; background: var(--gold); color: var(--navy);
			width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
			box-shadow: 0 10px 25px rgba(0,0,0,0.2); cursor: pointer; z-index: 1000;
		}
		#cart-count {
			position: absolute; top: 0; right: 0; background: var(--navy); color: white;
			width: 25px; height: 25px; border-radius: 50%; font-size: 0.8rem; display: flex; align-items: center; justify-content: center;
		}

		#cart-modal {
			display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000;
			align-items: center; justify-content: center; padding: 15px;
		}
		.modal-content {
			background: white; width: 100%; max-width: 550px; border-radius: 20px; padding: 2rem;
			max-height: 95vh; overflow-y: auto; position: relative;
		}

		.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
		.card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid rgba(212,175,55,0.2); text-align: center; }
		.card img { width: 100%; height: 280px; object-fit: cover; }
		.btn-add { background: var(--gold); color: var(--navy); padding: 0.8rem 1.5rem; border-radius: 50px; font-weight: bold; border: none; cursor: pointer; margin: 1rem 0; width: 85%; }
		
		header { background: var(--navy); padding: 1.5rem; color: white; border-bottom: 3px solid var(--gold); }
		.input-field { padding: 0.8rem; border-radius: 8px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; }
        .error-msg { color: #d93025; font-size: 0.85rem; margin-top: -10px; display: none; }
	</style>

	<header>
		<div style="max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center;">
			<h1 style="margin:0; color:var(--gold); font-family:'Playfair Display'">Cukrářství Blahutovi</h1>
			<nav>
				<a href="#dorty" style="color:white; margin-left:15px; text-decoration:none; font-weight:bold">Dorty</a>
				<a href="#zakusky" style="color:white; margin-left:15px; text-decoration:none; font-weight:bold">Zákusky</a>
			</nav>
		</div>
	</header>

	<div id="cart-float" onclick="toggleModal(true)">
		<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
		<div id="cart-count">0</div>
	</div>

	<div id="cart-modal">
		<div class="modal-content">
			<button onclick="toggleModal(false)" style="position:absolute; right:20px; top:20px; border:none; background:none; font-size:1.5rem; cursor:pointer">✕</button>
			<h2 style="font-family:'Playfair Display'; margin-top:0">Vaše objednávka</h2>
			
			<div id="cart-items" style="margin-bottom: 2rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
				<p style="text-align:center; opacity:0.5">Košík je prázdný.</p>
			</div>

			<form id="reservation-form" style="display:flex; flex-direction:column; gap:1.2rem;">
				<div>
					<label style="display:block; margin-bottom:5px; font-weight:bold">Kde si zboží vyzvednete?</label>
					<select id="pickup-store" class="input-field" required onchange="validateDate()">
						<option value="">-- Vyberte prodejnu --</option>
						{stores.map(s => <option value={s.id} data-closed={s.closed.join(',')}>{s.name} ({s.hours})</option>)}
					</select>
				</div>

				<div>
					<label style="display:block; margin-bottom:5px; font-weight:bold">Kdy zboží vyzvednete? (min. za 3 dny)</label>
					<input type="date" id="pickup-date" class="input-field" required onchange="validateDate()" />
					<p id="date-error" class="error-msg">V tento den máme zavřeno nebo je termín příliš brzy.</p>
				</div>

				<hr style="border:0; border-top:1px solid #eee" />

				<input type="text" id="cust-name" placeholder="Vaše jméno a příjmení" required class="input-field" />
				<input type="tel" id="cust-phone" placeholder="Telefon (pro potvrzení)" required class="input-field" />
				
				<button type="submit" id="submit-btn" class="btn-add" style="width:100%; margin:0">Rezervovat zboží</button>
				<p style="font-size:0.8rem; text-align:center; opacity:0.7">Po odeslání vás budeme kontaktovat pro potvrzení.</p>
			</form>
		</div>
	</div>

	<section id="dorty">
		<h2 class="section-title">Dětské a oslavné dorty</h2>
		<div class="grid">
			{cakes.map((p) => (
				<div class="card">
					<img src={p.foto} alt={p.title} loading="lazy" />
					<div style="padding:1.5rem">
						<h3 style="margin:0; font-size:1.1rem">{p.title}</h3>
						<p style="font-size:0.9rem; color:#666">{p.porce}</p>
						<p style="color:var(--gold); font-weight:bold; font-size:1.2rem">{p.cena}</p>
						<button class="btn-add" onclick={`addToCart('${p.title}', '${p.cena}')`}>Přidat do košíku</button>
					</div>
				</div>
			))}
		</div>
	</section>

	<section id="zakusky" style="margin-top:5rem">
		<h2 class="section-title">Čerstvé zákusky</h2>
		<div class="grid">
			{desserts.map((p) => (
				<div class="card">
					<img src={p.foto} alt={p.title} loading="lazy" />
					<div style="padding:1.5rem">
						<h3 style="margin:0; font-size:1.1rem">{p.title}</h3>
						<p style="color:var(--gold); font-weight:bold; font-size:1.2rem">{p.cena}</p>
						<button class="btn-add" onclick={`addToCart('${p.title}', '${p.cena}')`}>Přidat do košíku</button>
					</div>
				</div>
			))}
		</div>
	</section>

	<script is:inline>
		let cart = [];

		// Nastavení minimálního data (dnes + 3 dny)
		const dateInput = document.getElementById('pickup-date');
		const minDate = new Date();
		minDate.setDate(minDate.getDate() + 3);
		dateInput.min = minDate.toISOString().split('T')[0];

		function addToCart(title, price) {
			const existing = cart.find(item => item.title === title);
			if (existing) { existing.qty++; } 
			else { cart.push({ title, price, qty: 1 }); }
			updateCart();
			alert('Přidáno do košíku!');
		}

		function updateCart() {
			const countEl = document.getElementById('cart-count');
			const itemsEl = document.getElementById('cart-items');
			countEl.innerText = cart.reduce((sum, item) => sum + item.qty, 0);

			if (cart.length === 0) {
				itemsEl.innerHTML = '<p style="text-align:center; opacity:0.5">Košík je prázdný.</p>';
				return;
			}

			itemsEl.innerHTML = cart.map((item, index) => `
				<div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:0.9rem">
					<span><strong>${item.qty}x</strong> ${item.title}</span>
					<span>${item.price} <button onclick="removeItem(${index})" style="color:red; border:none; background:none; cursor:pointer">✕</button></span>
				</div>
			`).join('');
		}

		function removeItem(index) {
			cart.splice(index, 1);
			updateCart();
		}

		function validateDate() {
			const storeSelect = document.getElementById('pickup-store');
			const dateVal = dateInput.value;
			const errorEl = document.getElementById('date-error');
			const submitBtn = document.getElementById('submit-btn');
			
			if (!dateVal || !storeSelect.value) return;

			const selectedDate = new Date(dateVal);
			const dayOfWeek = selectedDate.getDay(); // 0 = Neděle, 1 = Pondělí...
			const closedDays = storeSelect.options[storeSelect.selectedIndex].dataset.closed.split(',').map(Number);

			if (closedDays.includes(dayOfWeek)) {
				errorEl.style.display = 'block';
				submitBtn.disabled = true;
				submitBtn.style.opacity = '0.5';
			} else {
				errorEl.style.display = 'none';
				submitBtn.disabled = false;
				submitBtn.style.opacity = '1';
			}
		}

		function toggleModal(show) {
			document.getElementById('cart-modal').style.display = show ? 'flex' : 'none';
		}

		document.getElementById('reservation-form').onsubmit = (e) => {
			e.preventDefault();
			if (cart.length === 0) return alert('Košík je prázdný!');
			
			const store = document.getElementById('pickup-store').options[document.getElementById('pickup-store').selectedIndex].text;
			const date = dateInput.value;
			const name = document.getElementById('cust-name').value;
			const items = cart.map(i => `${i.title} (${i.qty}ks)`).join(', ');

			const message = `Nová objednávka!\n\nJméno: ${name}\nProdejna: ${store}\nDatum: ${date}\nZboží: ${items}`;
			
			// Pro test účely alert, zde pak bude Netlify Forms
			alert('Objednávka byla odeslána k potvrzení! Děkujeme.');
			console.log(message);
			
			cart = [];
			updateCart();
			toggleModal(false);
			e.target.reset();
		};
	</script>
</Layout>
