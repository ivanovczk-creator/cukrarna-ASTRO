---
import Layout from '../layouts/Layout.astro';
import productsData from '../../data.json';
import CustomCakeForm from '../components/CustomCakeForm';
import ReservationForm from '../components/ReservationForm.tsx';
import EdiblePrintForm from '../components/EdiblePrintForm.tsx';
import { Image } from 'astro:assets';

const cakeImages = import.meta.glob<{ default: ImageMetadata }>('/public/img/dorty/*.{jpeg,jpg,png,webp,JPG,JPEG}', { eager: true });
const dessertImages = import.meta.glob<{ default: ImageMetadata }>('/public/img/zakusky/*.{jpeg,jpg,png,webp,JPG,JPEG}', { eager: true });

const cakes = (productsData?.cakes || []).sort((a, b) => (a.weight ?? 999) - (b.weight ?? 999));
const desserts = (productsData?.desserts || []).sort((a, b) => (a.weight ?? 999) - (b.weight ?? 999));

function getImage(path: string, images: Record<string, any>) {
	if (!path) return null;
	const normalizedPath = path.startsWith('/public') ? path : (path.startsWith('/') ? `/public${path}` : `/public/${path}`);
	return images[normalizedPath]?.default || null;
}

const stores = [
	{ id: 'petrvald', name: 'Petřvald', address: 'Šenovská 1, 735 41 Petřvald', phone: '+420 778 157 857', mapUrl: 'https://maps.google.com/?q=Šenovská+1+Petřvald', hours: 'Út–Ne: 9:00–17:00' },
	{ id: 'pist', name: 'Píšť', address: 'Opavská 218/101, 747 18 Píšť', phone: '+420 602 323 788', mapUrl: 'https://maps.google.com/?q=Opavská+218+Píšť', hours: 'Po–Pá: 6:00–15:00' },
	{ id: 'karvina', name: 'Karviná', address: 'tř. Těreškovové 2233/28, 734 01 Karviná', phone: '+420 778 157 867', mapUrl: 'https://maps.google.com/?q=tř.+Těreškovové+2233+Karviná', hours: 'Po–Pá: 9:00–17:00, So: 8:00–12:00' },
	{ id: 'ostrava', name: 'Ostrava (Zábřeh)', address: 'Výškovická 116a, 700 30 Ostrava-jih', phone: '+420 775 271 101', mapUrl: 'https://maps.google.com/?q=Výškovická+116a+Ostrava', hours: 'Po–Pá: 9:00–17:00, So: 9:00–12:00' }
];

// Definice kategorií pro rozcestník
const cakeCategories = [
	{ id: 'detske', name: 'Dětské' },
	{ id: 'narozeninove', name: 'Narozeninové' },
	{ id: 'svatebni', name: 'Svatební' },
	{ id: 'nahe', name: 'Nahé' }
];
---

<Layout title="Cukrářství Blahutovi | Domácí dorty a zákusky">
	<header class="bg-[#0a192f] text-white sticky top-0 z-50 border-b-2 border-[#d4af37]">
		<div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center relative text-navy-900">
			<h1 class="text-xl md:text-2xl font-serif text-[#d4af37]">Cukrářství Blahutovi</h1>
			<nav id="nav-menu" class="hidden lg:flex gap-6 uppercase text-[10px] font-bold tracking-widest text-white/90" aria-label="Hlavní navigace">
				<a href="#dorty" class="hover:text-[#d4af37] cursor-pointer py-2">Dorty</a>
				<a href="#zakusky" class="hover:text-[#d4af37] cursor-pointer py-2">Zákusky</a>
				<a href="#jedly-tisk" class="hover:text-[#d4af37] cursor-pointer py-2">Jedlý tisk</a>
				<a href="#dort-na-prani" class="hover:text-[#d4af37] cursor-pointer py-2">Dort na přání</a>
				<a href="#prodejny" class="hover:text-[#d4af37] cursor-pointer py-2">Prodejny</a>
			</nav>
			<div class="flex items-center gap-4">
				<ReservationForm client:load />
				<button id="menu-toggle" class="lg:hidden text-[#d4af37] p-2 cursor-pointer outline-none" aria-label="Otevřít mobilní menu">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
					</svg>
				</button>
			</div>
		</div>
	</header>

	<main>
		<section id="dorty" class="py-16 px-4 max-w-7xl mx-auto text-[#0a192f]">
			<h2 class="text-4xl font-serif text-center mb-6 italic">Naše Dorty</h2>
			
			<div class="flex flex-wrap justify-center gap-3 mb-12">
				{cakeCategories.map(cat => (
					<a 
						href={`/dorty/${cat.id}`} 
						class="px-5 py-2 rounded-full border border-slate-200 text-xs font-bold uppercase tracking-widest hover:border-[#d4af37] hover:text-[#92782a] transition-all shadow-sm bg-white"
					>
						{cat.name} dorty
					</a>
				))}
			</div>

			<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8 text-center">
				{cakes.map((cake, index) => {
					const fotoUrl = cake.foto || "";
					const imageSrc = getImage(fotoUrl, cakeImages);

					return (
					<div class="bg-white rounded-[2rem] shadow-lg border border-slate-100 overflow-hidden flex flex-col transition-all hover:shadow-xl">
						<div class="h-64 overflow-hidden relative bg-slate-50">
							{imageSrc ? (
								<a href={fotoUrl} class="glightbox cursor-zoom-in" aria-label={`Zobrazit detail dortu ${cake.title}`}>
									<Image 
										src={imageSrc} 
										alt={`Dort ${cake.title}`} 
										class="w-full h-full object-cover transition-transform duration-700 hover:scale-110" 
										width={400} 
										height={300} 
										format="webp"
										loading={index < 3 ? "eager" : "lazy"}
										fetchpriority={index === 0 ? "high" : "auto"}
									/>
								</a>
							) : (
								<div class="flex items-center justify-center h-full text-xs text-slate-400 italic">Foto připravujeme</div>
							)}
						</div>
						<div class="p-6 flex-grow flex flex-col justify-between">
							<div>
								<h3 class="text-xl font-bold mb-1">{cake.title}</h3>
								<p class="text-slate-600 text-sm mb-4">{cake.porce}</p>
							</div>
							<div>
								<p class="text-[#92782a] font-black text-2xl mb-4">{cake.cena}</p>
								<button 
									aria-label={`Přidat dort ${cake.title} do objednávky`}
									onclick={`window.dispatchEvent(new CustomEvent('add-to-cart', { detail: { name: "${cake.title}", price: "${cake.cena}", img: "${fotoUrl}", quantity: 1 } }))`}
									class="w-full bg-[#0a192f] text-white py-4 rounded-2xl font-bold hover:bg-[#d4af37] transition-all cursor-pointer uppercase tracking-widest text-[10px] active:scale-95 shadow-md"
								>
									Přidat do objednávky
								</button>
							</div>
						</div>
					</div>
				)})}
			</div>
		</section>

		<section id="zakusky" class="py-16 px-4 bg-slate-50 text-[#0a192f]">
			<div class="max-w-7xl mx-auto text-center">
				<h2 class="text-4xl font-serif text-center mb-12 italic">Naše Zákusky</h2>
				<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
					{desserts.map(dessert => {
						const fotoUrl = dessert.foto || "";
						const imageSrc = getImage(fotoUrl, dessertImages);
						const dessertId = dessert.title.replace(/\s+/g, '-').toLowerCase();

						return (
						<div class="bg-white rounded-[2rem] shadow-lg border border-slate-100 overflow-hidden flex flex-col transition-transform hover:-translate-y-1 text-navy-900">
							<div class="h-56 overflow-hidden relative bg-slate-50 text-center">
								{imageSrc ? (
									<a href={fotoUrl} class="glightbox cursor-zoom-in" aria-label={`Zobrazit detail zákusku ${dessert.title}`}>
										<Image src={imageSrc} alt={`Zákusek ${dessert.title}`} class="w-full h-full object-cover transition-transform duration-700 hover:scale-110" width={300} height={300} format="webp" />
									</a>
								) : (
									<div class="flex items-center justify-center h-full text-xs text-slate-400 italic">Foto připravujeme</div>
								)}
							</div>
							<div class="p-6 flex-grow flex flex-col justify-between">
								<h3 class="text-lg font-bold mb-1 leading-tight">{dessert.title}</h3>
								<div class="space-y-4">
									<p class="text-[#92782a] font-black text-xl">{dessert.cena}</p>
									
									<div class="flex flex-col items-center gap-2">
										<button 
											id={`init-btn-${dessertId}`}
											aria-label={`Zvolit počet kusů pro ${dessert.title}`}
											onclick={`
												document.getElementById('init-btn-${dessertId}').classList.add('hidden');
												document.getElementById('counter-${dessertId}').classList.remove('hidden');
												document.getElementById('counter-${dessertId}').classList.add('flex');
											`}
											class="w-full bg-[#0a192f] text-white py-3 rounded-xl font-bold hover:bg-[#d4af37] transition-all cursor-pointer uppercase tracking-widest text-[10px]"
										>
											Přidat
										</button>

										<div id={`counter-${dessertId}`} class="hidden w-full items-center justify-between bg-slate-100 rounded-xl overflow-hidden border border-slate-200">
											<button 
												aria-label="Snížit množství"
												onclick={`
													const input = document.getElementById('qty-${dessertId}');
													if(parseInt(input.value) > 1) { 
														input.value = parseInt(input.value) - 1;
													} else {
														document.getElementById('counter-${dessertId}').classList.add('hidden');
														document.getElementById('counter-${dessertId}').classList.remove('flex');
														document.getElementById('init-btn-${dessertId}').classList.remove('hidden');
													}
												`}
												class="w-10 h-10 flex items-center justify-center font-bold text-lg hover:bg-slate-200 transition-colors cursor-pointer"
											>
												−
											</button>
											<label for={`qty-${dessertId}`} class="sr-only">Počet kusů zákusku {dessert.title}</label>
											<input 
												type="number" 
												id={`qty-${dessertId}`} 
												min="1" 
												value="1" 
												class="w-12 bg-transparent text-center font-bold outline-none border-none p-0"
											/>
											<button 
												aria-label="Zvýšit množství"
												onclick={`const input = document.getElementById('qty-${dessertId}'); input.value = parseInt(input.value) + 1;`}
												class="w-10 h-10 flex items-center justify-center font-bold text-lg hover:bg-slate-200 transition-colors cursor-pointer"
											>
												+
											</button>
											<button 
												aria-label="Potvrdit výběr a přidat do košíku"
												onclick={`
													const q = document.getElementById('qty-${dessertId}').value;
													window.dispatchEvent(new CustomEvent('add-to-cart', { detail: { name: "${dessert.title}", price: "${dessert.cena}", img: "${fotoUrl}", quantity: q } }));
													document.getElementById('counter-${dessertId}').classList.add('hidden');
													document.getElementById('counter-${dessertId}').classList.remove('flex');
													document.getElementById('init-btn-${dessertId}').classList.remove('hidden');
													document.getElementById('qty-${dessertId}').value = 1;
												`}
												class="bg-[#0a192f] text-white px-3 h-10 font-bold text-[10px] uppercase hover:bg-[#d4af37] cursor-pointer"
											>
												OK
											</button>
										</div>
									</div>
								</div>
							</div>
						</div>
					)})}
				</div>
			</div>
		</section>

		<section id="jedly-tisk" class="py-20 px-4 bg-white"><EdiblePrintForm client:load /></section>
		<section id="dort-na-prani" class="py-20 px-4 bg-slate-50"><CustomCakeForm client:load /></section>

		<section id="prodejny" class="py-20 px-4 max-w-7xl mx-auto text-[#0a192f]">
			<h2 class="text-4xl font-serif text-center mb-12 italic text-navy-900">Navštivte nás</h2>
			<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 text-white text-left">
				{stores.map(store => (
					<div class="bg-[#0a192f] p-6 rounded-[2rem] border border-[#d4af37]/20 shadow-xl flex flex-col justify-between transition-transform hover:-translate-y-1">
						<div>
							<h3 class="text-[#d4af37] font-bold mb-1 text-xl">{store.name}</h3>
							<p class="text-[10px] uppercase tracking-widest text-slate-300 mb-4 font-bold">{store.hours}</p>
							<p class="text-sm opacity-90 mb-1 leading-relaxed">{store.address}</p>
							<p class="text-sm font-bold mb-4">{store.phone}</p>
						</div>
						<a href={store.mapUrl} target="_blank" class="block w-full text-center py-3 rounded-xl border border-[#d4af37] text-[#d4af37] hover:bg-[#d4af37] hover:text-[#0a192f] transition-all font-bold text-[10px] uppercase tracking-widest cursor-pointer" rel="noopener noreferrer" aria-label={`Zobrazit prodejnu ${store.name} na mapě`}>Ukázat na mapě</a>
					</div>
				))}
			</div>
		</section>
	</main>

	<footer class="bg-[#0a192f] py-12 text-center text-white/40 text-xs border-t border-[#d4af37]/10">
		<p class="mb-2 italic text-[#d4af37] text-sm font-serif">Cukrářství Blahutovi</p>
		<p>© {new Date().getFullYear()} — Všechna práva vyzrazena</p>
	</footer>
</Layout>

<script is:inline>
	function init() {
		const btn = document.getElementById('menu-toggle');
		const nav = document.getElementById('nav-menu');
		if (btn && nav) {
			btn.onclick = (e) => {
				e.preventDefault();
				const isHidden = nav.classList.contains('hidden');
				if (isHidden) {
					nav.classList.remove('hidden');
					nav.classList.add('flex', 'flex-col', 'absolute', 'top-20', 'left-0', 'w-full', 'bg-[#0a192f]', 'p-6', 'z-50', 'border-b', 'border-[#d4af37]');
				} else {
					nav.classList.add('hidden');
					nav.classList.remove('flex', 'flex-col', 'absolute', 'top-20', 'left-0', 'w-full', 'bg-[#0a192f]', 'p-6', 'z-50', 'border-b', 'border-[#d4af37]');
				}
			};
		}
	}
	init();
	document.addEventListener('astro:after-swap', init);
</script>
